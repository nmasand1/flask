import os
import requests
import boto3
import urllib3
from dotenv import load_dotenv

# Suppress SSL warnings if using unverified requests
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Load environment variables from .env file
load_dotenv()

AWS_USER = os.getenv("AWS_USER")
AWS_PASS = os.getenv("AWS_PASS")
REGION_NAME = os.getenv("REGION_NAME")
AWS_JWT_TOKEN_URL = os.getenv("AWS_JWT_TOKEN_URL")
AWS_SESSION_TOKEN_URL = os.getenv("AWS_SESSION_TOKEN_URL")
AWS_ROLE_ARN = os.getenv("AWS_ROLE_ARN")
BEDROCK_VPC_ENDPOINT = os.getenv("BEDROCK_VPC_ENDPOINT")
KNOWLEDGE_BASE_ID = os.getenv("KNOWLEDGE_BASE_ID")

def get_aws_credentials():
    """Authenticate with AWS and retrieve temporary credentials"""
    try:
        jwt_response = requests.post(
            AWS_JWT_TOKEN_URL,
            json={"username": AWS_USER, "password": AWS_PASS},
            headers={"content-type": "application/json", "accept": "*/*"},
            verify=False
        )
        jwt_response.raise_for_status()
        jwt_token = jwt_response.json().get("token")

        if not jwt_token:
            raise ValueError("JWT token not received.")

        creds_response = requests.get(
            f"{AWS_SESSION_TOKEN_URL}{AWS_ROLE_ARN}",
            headers={"authorization": f"Bearer {jwt_token}"},
            verify=False
        )
        creds_response.raise_for_status()

        credentials = creds_response.json().get("Credentials")
        if not credentials:
            raise ValueError("AWS credentials not received.")

        return credentials

    except requests.exceptions.RequestException as e:
        print(f"Error in authentication request: {e}")
        return None

def format_vpc_endpoint(endpoint):
    """Ensure the VPC endpoint starts with 'https://'"""
    if not endpoint.startswith("http"):
        return f"https://{endpoint}"
    return endpoint

def ask_knowledge_base(question):
    """Query AWS Bedrock Knowledge Base with a question"""
    creds = get_aws_credentials()
    if not creds:
        print("Failed to retrieve AWS credentials.")
        return None

    try:
        session = boto3.Session(
            aws_access_key_id=creds["AccessKeyId"],
            aws_secret_access_key=creds["SecretAccessKey"],
            aws_session_token=creds["SessionToken"],
            region_name=REGION_NAME
        )

        # Ensure VPC Endpoint URL is correctly formatted
        formatted_vpc_endpoint = format_vpc_endpoint(BEDROCK_VPC_ENDPOINT)

        # Connect to Bedrock Agent
        bedrock_agent = session.client("bedrock-agent-runtime", endpoint_url=formatted_vpc_endpoint)

        # Corrected API Call
        response = bedrock_agent.retrieve_and_generate(
            input={"text": question},  # The actual question to ask
            retrieveAndGenerateConfiguration={
                "type": "KNOWLEDGE_BASE",  # Required type field
                "knowledgeBaseConfiguration": {
                    "knowledgeBaseId": KNOWLEDGE_BASE_ID  # Correct parameter for knowledge base
                }
            }
        )

        return response

    except ValueError as ve:
        print(f"Configuration Error: {ve}")
    except Exception as e:
        print(f"Error querying Knowledge Base: {e}")

if __name__ == "__main__":
    question = "What is AWS Bedrock?"
    response = ask_knowledge_base(question)
    
    if response:
        print(response)
